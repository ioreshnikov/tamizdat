#!/usr/bin/env python3


import logging
from argparse import ArgumentParser

from tamizdat.command import (
    DownloadCommand,
    BookInfoCommand,
    SearchCommand)
from tamizdat.index import Index
from tamizdat.models import make_database
from tamizdat.response import (
    DownloadResponse,
    BookInfoResponse,
    SearchResponse)
from tamizdat.telegram_bot import TelegramBot
from tamizdat.website import Website


parser = ArgumentParser()
parser.add_argument(
    "--database",
    default="index.sqlite3",
    help="Path to the catalog database",
    type=str)

subparsers = parser.add_subparsers(
    dest="command",
    help="sub-command help")

parser_command_import = subparsers.add_parser(
    "import",
    help="import CSV catalog")
parser_command_import.add_argument(
    "catalog",
    help="Path to the catalog",
    type=str)

parser_command_search = subparsers.add_parser(
    "search",
    help="find a book in the index")
parser_command_search.add_argument(
    "terms",
    help="Search terms",
    type=str)

parser_command_info = subparsers.add_parser(
    "info",
    help="show book information")
parser_command_info.add_argument(
    "book_id",
    help="Book id",
    type=str)

parser_command_download = subparsers.add_parser(
    "download",
    help="download ebook")
parser_command_download.add_argument(
    "book_id",
    help="Book id",
    type=str)

parser_bot_start = subparsers.add_parser(
    "bot",
    help="start telegram bot")
parser_bot_start.add_argument(
    "token",
    help="Bot token",
    type=str)


args = parser.parse_args()
database = make_database(args.database)
index = Index(database)
website = Website()


logging.basicConfig(
    level=logging.DEBUG,
    format="%(asctime)s %(levelname)8s %(message)s")
peewee_logger = logging.getLogger("peewee")
peewee_logger.setLevel(logging.INFO)


if args.command == "import":
    with open(args.catalog) as catalog:
        index.import_catalog(catalog)

if args.command == "search":
    response = SearchCommand(index).execute(args.terms)
    print(response)

if args.command == "info":
    response = BookInfoCommand(index, website).execute(args.book_id)
    print(response)

if args.command == "download":
    response = DownloadCommand(index, website).execute(args.book_id)
    print(response)

if args.command == "bot":
    bot = TelegramBot(args.token, index, website)
    bot.serve()
